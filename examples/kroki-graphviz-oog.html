<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.5.4/firebase.js"></script>

    <!-- Firepad -->
    <link rel="stylesheet" href="https://firepad.io/releases/v1.5.9/firepad.css" />
    <script src="https://firepad.io/releases/v1.5.9/firepad.js"></script>

    <!-- Loader.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/loader.js"></script>

    <link rel="stylesheet" href="common.css" />
    <style>
    </style>

</head>
<body onload="init()">
<div id="firepad"></div>
<div class="mermaidboxwrap">
    <div class=""><button id="download">Download</button></div>
    <div id="mermaidbox" class="mermaidbox">

    </div>
    <a id="download_link" style="display: none;" download >Download</button>
</div>


<textarea id="defaultText" hidden>
  digraph "unix" {
    graph [ fontname = "Helvetica-Oblique",
            fontsize = 36,
            label = "\n\n\n\nObject Oriented Graphs\nStephen North, 3/19/93",
            size = "6,6" ];
    node [ shape = polygon,
           sides = 4,
           distortion = "0.0",
           orientation = "0.0",
           skew = "0.0",
           color = white,
           style = filled,
           fontname = "Helvetica-Outline" ];
    "5th Edition" [sides=9, distortion="0.936354", orientation=28, skew="-0.126818", color=salmon2];
    "6th Edition" [sides=5, distortion="0.238792", orientation=11, skew="0.995935", color=deepskyblue];
    "PWB 1.0" [sides=8, distortion="0.019636", orientation=79, skew="-0.440424", color=goldenrod2];
    LSX [sides=9, distortion="-0.698271", orientation=22, skew="-0.195492", color=burlywood2];
    "1 BSD" [sides=7, distortion="0.265084", orientation=26, skew="0.403659", color=gold1];
    "Mini Unix" [distortion="0.039386", orientation=2, skew="-0.461120", color=greenyellow];
    Wollongong [sides=5, distortion="0.228564", orientation=63, skew="-0.062846", color=darkseagreen];
    Interdata [distortion="0.624013", orientation=56, skew="0.101396", color=dodgerblue1];
    "Unix/TS 3.0" [sides=8, distortion="0.731383", orientation=43, skew="-0.824612", color=thistle2];
    "PWB 2.0" [sides=6, distortion="0.592100", orientation=34, skew="-0.719269", color=darkolivegreen3];
    "7th Edition" [sides=10, distortion="0.298417", orientation=65, skew="0.310367", color=chocolate];
    "8th Edition" [distortion="-0.997093", orientation=50, skew="-0.061117", color=turquoise3];
    "32V" [sides=7, distortion="0.878516", orientation=19, skew="0.592905", color=steelblue3];
    V7M [sides=10, distortion="-0.960249", orientation=32, skew="0.460424", color=navy];
    "Ultrix-11" [sides=10, distortion="-0.633186", orientation=10, skew="0.333125", color=darkseagreen4];
    Xenix [sides=8, distortion="-0.337997", orientation=52, skew="-0.760726", color=coral];
    "UniPlus+" [sides=7, distortion="0.788483", orientation=39, skew="-0.526284", color=darkolivegreen3];
    "9th Edition" [sides=7, distortion="0.138690", orientation=55, skew="0.554049", color=coral3];
    "2 BSD" [sides=7, distortion="-0.010661", orientation=84, skew="0.179249", color=blanchedalmond];
    "2.8 BSD" [distortion="-0.239422", orientation=44, skew="0.053841", color=lightskyblue1];
    "2.9 BSD" [distortion="-0.843381", orientation=70, skew="-0.601395", color=aquamarine2];
    "3 BSD" [sides=10, distortion="0.251820", orientation=18, skew="-0.530618", color=lemonchiffon];
    "4 BSD" [sides=5, distortion="-0.772300", orientation=24, skew="-0.028475", color=darkorange1];
    "4.1 BSD" [distortion="-0.226170", orientation=38, skew="0.504053", color=lightyellow1];
    "4.2 BSD" [sides=10, distortion="-0.807349", orientation=50, skew="-0.908842", color=darkorchid4];
    "4.3 BSD" [sides=10, distortion="-0.030619", orientation=76, skew="0.985021", color=lemonchiffon2];
    "Ultrix-32" [distortion="-0.644209", orientation=21, skew="0.307836", color=goldenrod3];
    "PWB 1.2" [sides=7, distortion="0.640971", orientation=84, skew="-0.768455", color=cyan];
    "USG 1.0" [distortion="0.758942", orientation=42, skew="0.039886", color=blue];
    "CB Unix 1" [sides=9, distortion="-0.348692", orientation=42, skew="0.767058", color=firebrick];
    "USG 2.0" [distortion="0.748625", orientation=74, skew="-0.647656", color=chartreuse4];
    "CB Unix 2" [sides=10, distortion="0.851818", orientation=32, skew="-0.020120", color=greenyellow];
    "CB Unix 3" [sides=10, distortion="0.992237", orientation=29, skew="0.256102", color=bisque4];
    "Unix/TS++" [sides=6, distortion="0.545461", orientation=16, skew="0.313589", color=mistyrose2];
    "PDP-11 Sys V" [sides=9, distortion="-0.267769", orientation=40, skew="0.271226", color=cadetblue1];
    "USG 3.0" [distortion="-0.848455", orientation=44, skew="0.267152", color=bisque2];
    "Unix/TS 1.0" [distortion="0.305594", orientation=75, skew="0.070516", color=orangered];
    "TS 4.0" [sides=10, distortion="-0.641701", orientation=50, skew="-0.952502", color=crimson];
    "System V.0" [sides=9, distortion="0.021556", orientation=26, skew="-0.729938", color=darkorange1];
    "System V.2" [sides=6, distortion="0.985153", orientation=33, skew="-0.399752", color=darkolivegreen4];
    "System V.3" [sides=7, distortion="-0.687574", orientation=58, skew="-0.180116", color=lightsteelblue1];
    "5th Edition" -> "6th Edition";
    "5th Edition" -> "PWB 1.0";
    "6th Edition" -> LSX;
    "6th Edition" -> "1 BSD";
    "6th Edition" -> "Mini Unix";
    "6th Edition" -> Wollongong;
    "6th Edition" -> Interdata;
    Interdata -> "Unix/TS 3.0";
    Interdata -> "PWB 2.0";
    Interdata -> "7th Edition";
    "7th Edition" -> "8th Edition";
    "7th Edition" -> "32V";
    "7th Edition" -> V7M;
    "7th Edition" -> "Ultrix-11";
    "7th Edition" -> Xenix;
    "7th Edition" -> "UniPlus+";
    V7M -> "Ultrix-11";
    "8th Edition" -> "9th Edition";
    "1 BSD" -> "2 BSD";
    "2 BSD" -> "2.8 BSD";
    "2.8 BSD" -> "Ultrix-11";
    "2.8 BSD" -> "2.9 BSD";
    "32V" -> "3 BSD";
    "3 BSD" -> "4 BSD";
    "4 BSD" -> "4.1 BSD";
    "4.1 BSD" -> "4.2 BSD";
    "4.1 BSD" -> "2.8 BSD";
    "4.1 BSD" -> "8th Edition";
    "4.2 BSD" -> "4.3 BSD";
    "4.2 BSD" -> "Ultrix-32";
    "PWB 1.0" -> "PWB 1.2";
    "PWB 1.0" -> "USG 1.0";
    "PWB 1.2" -> "PWB 2.0";
    "USG 1.0" -> "CB Unix 1";
    "USG 1.0" -> "USG 2.0";
    "CB Unix 1" -> "CB Unix 2";
    "CB Unix 2" -> "CB Unix 3";
    "CB Unix 3" -> "Unix/TS++";
    "CB Unix 3" -> "PDP-11 Sys V";
    "USG 2.0" -> "USG 3.0";
    "USG 3.0" -> "Unix/TS 3.0";
    "PWB 2.0" -> "Unix/TS 3.0";
    "Unix/TS 1.0" -> "Unix/TS 3.0";
    "Unix/TS 3.0" -> "TS 4.0";
    "Unix/TS++" -> "TS 4.0";
    "CB Unix 3" -> "TS 4.0";
    "TS 4.0" -> "System V.0";
    "System V.0" -> "System V.2";
    "System V.2" -> "System V.3";
  }
 </textarea>  

 <script src="https://cdn.jsdelivr.net/gh/webmodule/foo/foo.js"></script>
 <script src="js/fire.config.js"></script>
<script>
    var KROKI_CONTEXT = 'graphviz';
    function textEncode(str) {
      if (window.TextEncoder) {
        return new TextEncoder('utf-8').encode(str);
      }
      var utf8 = unescape(encodeURIComponent(str));
      var result = new Uint8Array(utf8.length);
      for (var i = 0; i < utf8.length; i++) {
        result[i] = utf8.charCodeAt(i);
      }
      return result;
    }

    var CODE_PAD;
    function init() {
        //// Initialize Firebase.
        //// TODO: replace with your Firebase project configuration.
        var config = fireConfig();
        firebase.initializeApp(config);

        //// Get Firebase Database reference.
        var firepadRef = getExampleRef();

        //// Create Monaco and firepad.
        require.config({ 
            paths: {
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs',
                'dist' : 'https://unpkg.com/mermaid@8.6.4/dist',
                'js-base64' : 'https://cdn.jsdelivr.net/npm/js-base64@3.4.4',
                'pako' : 'https://unpkg.com/pako@1.0.10'
            }
        });
        require(['vs/editor/editor.main'], function() {

            monaco.languages.register({ id: 'mermaid' });
            // Register a tokens provider for the language
            monaco.languages.setMonarchTokensProvider('mermaid', {
                typeKeywords: [
                  'graph', 'stateDiagram', 'sequenceDiagram', 'classDiagram', 'pie', 'flowchart', 'gantt'
                ],
                keywords: [
                'patricipant','as'
                ],
                arrows: [
                  '---', '===', '-->', '==>'
                ],
                tokenizer: {
                  root: [
                    [/[{}]/, 'delimiter.bracket'],
                    [/[a-z_$][\w$]*/, { cases: { '@typeKeywords': 'keyword',
                                            '@keywords': 'keyword'} }],
                    [/[-=>ox]+/, { cases: { '@arrows': 'transition'} }],
                    [/[\[\{\(}]+.+?[\)\]\}]+/, "string"],
                    [/\".*\"/, "string"],
                  ]
                },
                whitespace: [
                    [/[ \t\r\n]+/, 'white'],
                    [/\%\%.*$/,    'comment'],
                ],
            });

            self.MonacoEnvironment = {
                getWorkerUrl: function (moduleId, label) {
                    return './editor.worker.bundle.js';
                }
            }

            // Define a new theme that contains only rules that match this language
            monaco.editor.defineTheme('myCoolTheme', {
                base: 'vs',
                inherit: false,
                rules: [
                  { token: 'keyword', foreground: '880000', fontStyle: 'bold' },
                  { token: 'custom-error', foreground: 'ff0000', fontStyle: 'bold' },
                  { token: 'string', foreground: 'AA8500' },
                  { token: 'transition', foreground: '008800', fontStyle: 'bold'},
                  { token: 'delimiter.bracket', foreground: '000000', fontStyle: 'bold'},
                ]
              });

            // Register a completion item provider for the new language
            monaco.languages.registerCompletionItemProvider('mySpecialLanguage', {
                provideCompletionItems: () => {
                    var suggestions = [{
                        label: 'simpleText',
                        kind: monaco.languages.CompletionItemKind.Text,
                        insertText: 'simpleText'
                    }, {
                        label: 'testing',
                        kind: monaco.languages.CompletionItemKind.Keyword,
                        insertText: 'testing(${1:condition})',
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet
                    }, {
                        label: 'ifelse',
                        kind: monaco.languages.CompletionItemKind.Snippet,
                        insertText: [
                            'if (${1:condition}) {',
                            '\t$0',
                            '} else {',
                            '\t',
                            '}'
                        ].join('\n'),
                        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                        documentation: 'If-Else Statement'
                    }];
                    return { suggestions: suggestions };
                }
            });

            editor = monaco.editor.create(
                document.getElementById('firepad'),
                {
                  theme: 'myCoolTheme',
                  // value: getCode(),
                  //language: 'mySpecialLanguage'
                  language: 'mermaid',
                  minimap: {
                    enabled: false
                  }
                }
            );
            Firepad.fromMonaco(firepadRef, editor,{
                defaultText: document.getElementById("defaultText").innerText
            });
            CODE_PAD = editor;
            editor.onDidChangeModelContent(function(editor, change) {
                window.renderChart();
            });
        });

        require(['pako/dist/pako'], function(pako) {
            var mermaidDiv = document.getElementById("mermaidbox");
            window.renderChart = debounce(function () {
                var data = textEncode(CODE_PAD.getValue());
                var compressed = pako.deflate(data, { level: 9, to: 'string' });
                var result = btoa(compressed).replace(/\+/g, '-').replace(/\//g, '_');
                mermaidDiv.innerHTML = '<img src=https://kroki.io/'+ KROKI_CONTEXT +'/svg/'+result+' />'
            },1500);
        });

        var btn = document.querySelector('#download');
        btn.addEventListener('click', function () {
            var img = document.querySelector("#mermaidbox img");
              const element = document.querySelector('#download_link');
              element.setAttribute('href', img.src);
              element.setAttribute('download', "flowchart.png");
              element.setAttribute('target', "_blank");
              //document.body.appendChild(element);
              element.click();
        });

    }

    // Helper to get hash from end of URL or generate a random one.
    function getExampleRef() {
        var ref = firebase.database().ref();
        var hash = window.location.hash.replace(/#/g, '');
        if (hash) {
            ref = ref.child(hash);
        } else {
            ref = ref.push(); // generate unique location.
            window.location = window.location + '#' + ref.key; // add it as a hash to the URL.
        }
        if (typeof console !== 'undefined') {
            console.log('Firebase data: ', ref.toString());
        }
        return ref;
    }


</script>


<style type="text/css">
    #mermaidbox #graphDiv{
        font-size: 90%;
    }
</style>

</html>
